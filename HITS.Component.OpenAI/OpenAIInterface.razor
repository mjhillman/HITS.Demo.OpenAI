@page "/"

@using MudBlazor

<MudText Typo="Typo.h5">Text and Code Completion</MudText>
<br />
<MudGrid Justify="Justify.FlexStart">
    @if (ShowWarning)
    {
        <MudItem xs="12" sm="7">
            <MudPaper>
            <MudText Typo="Typo.body1">
                While safeguards are in place, the system may occasionally generate incorrect or misleading information and produce offensive or biased content. It is not intended to give advice.
                Please don't share any sensitive information in your conversations.<br />
            </MudText>
        </MudPaper>
    </MudItem>
    }
    <MudItem xs="12" sm="7">
        <MudTextField T="string" 
                        Label="Submit a question."
                        Variant="Variant.Outlined"
                        Margin="Margin.Dense"
                        Lines="5"
                        @bind-Value="openAIRequest.Prompt" />
        @if (ShowOptions)
        {
            <br />
            <MudTooltip Placement="Placement.Right" Delay="2000">
                <ChildContent>
                    <MudSelect @bind-Value="@openAIRequest.Model" 
                    Label="Model Choices" 
                    Variant="Variant.Outlined">
                        <MudSelectItem Value="@("text-davinci-003")">Text:Davinci (default)</MudSelectItem>
                        <MudSelectItem Value="@("text-curie-001")">Text:Curie</MudSelectItem>
                        <MudSelectItem Value="@("text-babbage-001")">Text:Babbage</MudSelectItem>
                        <MudSelectItem Value="@("text-ada-001")">Text:Ada</MudSelectItem>
                        <MudSelectItem Value="@("code-davinci-002")">Code:Davinci</MudSelectItem>
                        <MudSelectItem Value="@("code-cushman-001")">Code:Cushman</MudSelectItem>
                    </MudSelect>
                </ChildContent>
                <TooltipContent>
                    <MudText Typo="Typo.body1">
                        Use the "text-" models for text completion. <br />
                        Use the "code-" models for code completion. 
                    </MudText>
                </TooltipContent>
            </MudTooltip>
            <br /><br />
            <MudSlider @bind-Value="@openAIRequest.MaxTokens"
                   Min="16"
                   Max="2048"
                   Step="8"
                   Class="border-solid border-2 pa-4 rounded">
                Max Tokens: @openAIRequest.MaxTokens.ToString()
            </MudSlider>
            <br /><br />
            <MudTooltip Placement="Placement.Right" Delay="2000">
                <ChildContent>
                <MudSlider @bind-Value="@openAIRequest.Temperature"
                           Min="0.0"
                           Max="1.0"
                           Step="0.1"
                           Class="border-solid border-2 pa-4 rounded">
                    Temperature: @openAIRequest.Temperature.ToString()
                </MudSlider>
            </ChildContent>
            <TooltipContent>
                <MudText Typo="Typo.body1">
                    OpenAI temperature is a parameter used to control the <br />
                    randomness of text generated by OpenAI's GPT-3 language model. <br />
                    It is a measure of how much the model should deviate from the <br />
                    training data when generating new text. A higher temperature <br />
                    will result in more creative and varied output, while a lower <br />
                    temperature will produce more conservative and accurate results.
                </MudText>
            </TooltipContent>
        </MudTooltip>
        <br />
        }   <!--end of show options-->
        <br />
        <MudButton Variant="Variant.Filled"
                   @onclick="OnSubmitAsync"
                   Disabled="@_processing" 
                   Color="Color.Primary">
            @if (_processing)
            {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Processing</MudText>
            }
            else
            {
                    <MudText>Submit</MudText>
            }
        </MudButton>  
    </MudItem>
    <MudItem xs="12" sm="7">
        <MudPaper>
            <MudText Typo="Typo.body1">@_response</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private string _response = "";
    private bool _processing = false;
 
    private OpenAIRequest openAIRequest = new OpenAIRequest();

    [Parameter]
    public string ApiKey { get; set; }

    [Parameter]
    public string OrgId { get; set; }

    [Parameter]
    public bool ShowWarning { get; set; } = true;

    [Parameter]
    public bool ShowOptions { get; set; } = true;

    private async Task OnSubmitAsync()
    {
        try
        {
            _response = "";
            _processing = true;
            await Task.Delay(100);

            if (!string.IsNullOrWhiteSpace(openAIRequest.Prompt))
            {
                using (OpenAI openAI = new OpenAI(ApiKey, OrgId))
                {
                    _response = openAI.CallOpenAI(openAIRequest);
                    openAIRequest.Prompt = "";
                }
            }
            else
            {
                _response = "Please enter some prompt text.";
            }

            _processing = false;
        }
        catch (Exception)
        {
            throw;
        }
    }

    protected override void OnInitialized()
    {
        openAIRequest.Prompt = "Who was Thomas Paine?";
        openAIRequest.Temperature = 0;
        openAIRequest.Model = "text-davinci-003";
        openAIRequest.MaxTokens = 256;
    }
}